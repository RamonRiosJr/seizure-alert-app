<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shake Sensor Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            word-wrap: break-word;
        }

        .box {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .success {
            background: #dcfce7;
            border-color: #86efac;
            color: #166534;
        }

        .error {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }

        button {
            font-size: 1.2rem;
            padding: 10px 20px;
            width: 100%;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>Shake Sensor Diagnostic</h1>

    <div id="status" class="box">Initializing...</div>
    <div id="data" class="box">Waiting for motion...</div>

    <button id="reqBtn" style="display:none;">Request iOS Permission</button>

    <script>
        const statusEl = document.getElementById('status');
        const dataEl = document.getElementById('data');
        const reqBtn = document.getElementById('reqBtn');

        function log(msg, type = '') {
            statusEl.textContent = msg;
            statusEl.className = 'box ' + type;
        }

        // 1. Check secure context (HTTPS/Localhost)
        if (!window.isSecureContext) {
            log('❌ Not Secure Context! Sensors require HTTPS.', 'error');
        } else {
            log('✅ Secure Context. Checking sensors...');
        }

        // 2. Check API existence
        if (!('DeviceMotionEvent' in window)) {
            log('❌ DeviceMotionEvent API missing.', 'error');
        } else {
            // Check permissions existence (iOS 13+)
            // @ts-ignore
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                log('⚠️ iOS 13+ detected. Permission needed.', '');
                reqBtn.style.display = 'block';
                reqBtn.onclick = async () => {
                    try {
                        // @ts-ignore
                        const response = await DeviceMotionEvent.requestPermission();
                        if (response === 'granted') {
                            log('✅ Permission granted!', 'success');
                            startListening();
                        } else {
                            log('❌ Permission denied: ' + response, 'error');
                        }
                    } catch (e) {
                        log('❌ Permission detected error: ' + e, 'error');
                    }
                };
            } else {
                log('✅ Standard API detected. Listening...', 'success');
                startListening();
            }
        }

        function startListening() {
            window.addEventListener('devicemotion', (event) => {
                const acc = event.accelerationIncludingGravity;
                if (!acc) return;

                const x = acc.x ? acc.x.toFixed(2) : '-';
                const y = acc.y ? acc.y.toFixed(2) : '-';
                const z = acc.z ? acc.z.toFixed(2) : '-';

                dataEl.innerHTML = `
                    <strong>Acceleration (inc. Gravity):</strong><br>
                    X: ${x}<br>
                    Y: ${y}<br>
                    Z: ${z}<br><br>
                    <em>Shake device to see values change.</em>
                `;
            });
        }
    </script>
</body>

</html>